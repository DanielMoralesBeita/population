(function(){log=console.log;function a(){}function b(c){return c.split("/").slice(-1)[0]}function c(d){return d.split(".").slice(0,-1).join(".")}function d(e){return e.split(".").pop();}function e(f){return document.getElementById(f);}function f(g){return document.getElementsByTagName(g)[0];}function g(h){return document.createElement(h);}function h(i,j,k){var l=g("script");j=j||a;k=k||a;l.src=i;l.addEventListener("load",j);l.addEventListener("error",k);document.head.appendChild(l);}function i(j,k){j.prototype=Object.create(k.prototype,{constructor:j});}var j=Math.abs;var k=Math.acos;var l=Math.cos;var m=Math.floor;var n=Math.max;var o=Math.min;var p=Math.PI;var q=Math.pow;var r=Math.random;var s=Math.round;var t=Math.sin;var u=Math.sqrt;function v(w,x){var y=w%x;return y+(y<0)*x;}function w(x){return x*p/180;}function x(y){return y*180/p;}function y(z,A,B){return n(z,o(A,B));}function z(A,B){return m(r()*(B-A+1)+A);}function A(B,C){B*=15485863;var D=B;D*=C||1;D^=D>>2;D^=D<<5;D^=D>>11;D^=D<<17;D^=D>>23;D^=D<<31;return(D+0x80000000)/0xFFffFFff;}function B(C,D,E){C*=15485863;D*=285058399;var F=C+D;F*=E||1;F^=F>>2;F^=F<<5;F^=F>>11;F^=F<<17;F^=F>>23;F^=F<<31;return(F+0x80000000)/0xFFffFFff;}function C(D,E,F){return D*(1-F)+E*F;}function D(E,F,G){return E+G*G*(3-2*G)*(F-E);}function E(F,G){return[F[0]/G[0],F[1]/G[1],];}function F(G,H){return[G[0],G[1],H];}function G(H){return[H[0],H[1]];}function H(I,J){return[I[0]+J[0],I[1]+J[1],I[2]+J[2],];}function I(J,K){return[J[1]*K[2]-J[2]*K[1],J[2]*K[0]-J[0]*K[2],J[0]*K[1]-J[1]*K[0],];}function J(K){return u(K[0]*K[0]+K[1]*K[1]+K[2]*K[2]);}function K(L){var M=J(L);return[L[0]/M,L[1]/M,L[2]/M,];}function L(M,N){var O=t(N);var P=l(N);return[M[0],M[1]*P-M[2]*O,M[2]*P+M[1]*O,];}function M(N,O){var P=t(O);var Q=l(O);return[N[0]*Q+N[2]*P,N[1],N[2]*Q-N[0]*P,];}function N(O,P){var Q=t(P);var R=l(P);return[O[0]*R-O[1]*Q,O[1]*R+O[0]*Q,O[2],];}function O(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1],]}function P(){this.left=0;this.top=0;this.right=0;this.bottom=0;this.width=0;this.height=0;this.rows=[];this.cellFactory=function(){return undefined;};}P.prototype={constructor:P,get:function(Q){var R=Q[0];var S=Q[1];this.expandTo(Q);return(this.rows[S-this.top][R-this.left]||(this.rows[S-this.top][R-this.left]=this.cellFactory(Q)));},set:function(Q,R){var S=Q[0];var T=Q[1];this.expandTo(Q);this.rows[T-this.top][S-this.left]=R;},each:function(Q){for(var R=0;R<this.rows.length;R++){var S=this.rows[R];for(var T=0;T<S.length;T++){var U=S[T];if(U!==undefined){Q(U,T,R);}}}},expandTo:function(Q){var R=Q[0];var S=Q[1];if(R<this.left){this.expandLeft(R);}else if(R>=this.right){this.expandRight(R+1);}if(S<this.top){this.expandTop(S);}else if(S>=this.bottom){this.expandBottom(S+1);}},expandLeft:function(Q){var R=this.left-Q;if(R<=0)return;for(var S=0;S<this.rows.length;S++){this.rows[S]=Array(R).concat(this.rows[S]);}this.left=Q;this.width+=R;},expandRight:function(Q){var R=Q-this.right;if(R<=0)return;for(var S=0;S<this.rows.length;S++){this.rows[S]=this.rows[S].concat(Array(R));}this.right=Q;this.width+=R;},expandTop:function(Q){var R=this.top-Q;if(R<=0)return;this.rows=Array(R).concat(this.rows);for(var S=0;S<R;S++){this.rows[S]=Array(this.width);}this.top=Q;this.height+=R;},expandBottom:function(Q){var R=Q-this.bottom;if(R<=0)return;this.rows=this.rows.concat(Array(R));for(var S=0;S<R;S++){this.rows[this.height+S]=Array(this.width);}this.bottom=Q;this.height+=R;},};function Q(R,S,T){this.seed=R;this.zoom=S;this.amp=T;this.samples=new P();this.samples.cellFactory=this.cellFactory.bind(this);}Q.prototype={constructor:Q,sample:function(R){var S=R[0];var T=R[1];var U=S/this.zoom;var V=T/this.zoom;var W=m(U);var X=m(V);var R=U-W;var Y=V-X;var Z=this.samples.get([W,X]);var ab=this.samples.get([W+1,X]);var bb=this.samples.get([W,X+1]);var cb=this.samples.get([W+1,X+1]);var db=D;return this.amp*db(db(Z,ab,R),db(bb,cb,R),Y);},cellFactory:function(R){return B(R[0],R[1],this.seed);},};function R(){this.layers=[new Q(0,1,1),new Q(1,2,2),];}R.prototype={constructor:R,sample:function(S){var T=0;var U=0;for(var V=0;V<this.layers.length;V++){T+=this.layers[V].sample(S);U+=this.layers[V].amp}return T/U;},};var S={};var T={itemsToLoad:0,waitCallback:a,errorCallback:a,ready:function(U){if(this.itemsToLoad===0){U();}else{this.waitCallback=U;}return this;},error:function(U){this.errorCallback=U;return this;},onError:function(U){this.errorCallback(U);},parseUrl:function(U){var V=U.split("/").filter(Boolean);for(var W=0;W<V.length;W++){V[W]=this.filenameToIdent(V[W]);}return V;},filenameToIdent:function(U){return U.replace(/[^a-zA-Z0-9]+/g,"_");},setItem:function(U,V){var W=this.parseUrl(U);var X=S;var Y=W[W.length-1];if(W.length>1){for(var Z=0;Z<W.length-1;Z++){var ab=W[Z];if(X[ab]===undefined){X[ab]={}}X=X[ab]}}X[Y]=V;},getItem:function(U){var V=this.parseUrl(U);var W=S;var X=V[V.length-1];if(V.length>1){for(var Y=0;Y<V.length-1;Y++){var Z=V[Y];if(W[Z]===undefined){return undefined;}W=W[Z]}}return W[X];},image:function(U,V){var W=g("img");function X(){this.setItem(U,W);this.itemsToLoad--;V();if(this.itemsToLoad===0){var Y=this.waitCallback;this.waitCallback=a;Y.call(this);}}V=V||a;if(this.getItem(U)!==undefined){V();return this;}this.itemsToLoad++;W.addEventListener("load",X.bind(this));W.addEventListener("error",this.onError.bind(this,U));W.src=U;return this;},text:function(U,V){var W=new XMLHttpRequest();function X(){if(W.status===200){this.setItem(U,W.responseText);this.itemsToLoad--;V();if(this.itemsToLoad===0){var Y=this.waitCallback;this.waitCallback=a;Y.call(this);}}else{this.onError(U);}}V=V||a;if(this.getItem(U)!==undefined){V();return this;}this.itemsToLoad++;W.open("GET",U);W.addEventListener("load",X.bind(this));W.send();return this;},json:function(U,V){function W(){var X=this.getItem(U);var Y=JSON.parse(X);this.setItem(U,Y);V();}V=V||a;if(this.getItem(U)!==undefined){V();return this;}this.text(U,W.bind(this));return this;},script:function(U,V){function W(){this.setItem(U,true);this.itemsToLoad--;V();if(this.itemsToLoad===0){var X=this.waitCallback;this.waitCallback=a;X.call(this);}}V=V||a;if(this.getItem(U)!==undefined){V();return this;}this.itemsToLoad++;h(U,W.bind(this),this.onError.bind(this,U));return this;},};function U(){this.onWindowResize=this.onWindowResize.bind(this);this.onFrame=this.onFrame.bind(this);this.onRender=a;this.onResize=a;this.container=g("div");this.canvas=g("canvas");this.gl=this.canvas.getContext("webgl",{antialias:false,alpha:false});this.glia=this.gl.getExtension("ANGLE_instanced_arrays");this.glfd=this.gl.getExtension("EXT_frag_depth");this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.disable(this.gl.DEPTH_TEST);this.resize(800,600);this.setBgColor(0.0,0.0,0.0,1.0);this.container.appendChild(this.canvas);this.container.style.position="relative";this.container.style.overflow="hidden";requestAnimationFrame(this.onFrame);}U.prototype={constructor:U,attachTo:function(V){V.appendChild(this.container);return this;},attachToBody:function(){this.attachTo(document.body);return this;},detach:function(){this.container.remove();return this;},resize:function(V,W){this.width=m(V/2)*2;this.height=m(W/2)*2;this.canvas.width=this.width;this.canvas.height=this.height;this.container.style.width=this.width+"px";this.container.style.height=this.height+"px";this.gl.viewport(0,0,this.width,this.height);return this;},enableFullPageMode:function(){this.container.style.position="absolute";this.container.style.top="0";this.container.style.left="0";this.canvas.style.position="absolute";this.canvas.style.top="0";this.canvas.style.left="0";addEventListener("resize",this.onWindowResize);this.onWindowResize();return this;},disableFullPageMode:function(){this.container.style.position="relative";this.container.style.top="";this.container.style.left="";this.canvas.style.position="";this.canvas.style.top="";this.canvas.style.left="";removeEventListener("resize",this.onWindowResize);return this;},setBgColor:function(V,W,X,Y){this.bgColor=[V,W,X,Y];this.gl.clearColor(V,W,X,Y);return this;},onWindowResize:function(){this.resize(innerWidth,innerHeight);},onFrame:function(V){this.gl.clear(this.gl.COLOR_BUFFER_BIT);this.onRender(V);requestAnimationFrame(this.onFrame);},};var V=new U();function W(X,Y,Z){Z=Z||V;var ab=Z.gl;this.display=Z;this.gl=Z.gl;this.type=X;this.indexBuf=Y||false;this.target=this.indexBuf?ab.ELEMENT_ARRAY_BUFFER:ab.ARRAY_BUFFER;this.buf=this.gl.createBuffer();this.len=0;this.data=null;this.invalidRange=[0,0];this.arraytype=(X==="byte"?Int8Array:X==="short"?Int16Array:X==="ubyte"?Uint8Array:X==="ushort"?Uint16Array:X==="float"?Float32Array:null);this.gltype=(X==="byte"?ab.BYTE:X==="short"?ab.SHORT:X==="ubyte"?ab.UNSIGNED_BYTE:X==="ushort"?ab.UNSIGNED_SHORT:X==="float"?ab.FLOAT:null);if(this.arraytype===null){throw"Error: unknown buffer type given";}}W.prototype={constructor:W,resize:function(X){var Y=this.gl;data=new this.arraytype(X);if(this.data!==null){data.set(this.data.subarray(0,o(this.len,X)));}this.data=data;this.len=X;Y.bindBuffer(this.target,this.buf);Y.bufferData(this.target,this.data,Y.STATIC_DRAW);this.invalidRange=[this.len,0];return this;},update:function(){var X=this.gl;if(this.invalidRange[0]<this.invalidRange[1]){X.bindBuffer(this.target,this.buf);X.bufferSubData(this.target,this.invalidRange[0]*this.arraytype.BYTES_PER_ELEMENT,this.data.subarray(this.invalidRange[0],this.invalidRange[1]));this.invalidRange=[this.len,0];}return this;},set:function(X,Y){X=X||0;Y=Array.isArray(Y)?Y:[Y];this.data.set(Y,X);this.invalidRange=[o(this.invalidRange[0],X),n(this.invalidRange[1],X+Y.length),];return this;},};W.fromArray=function(X,Y,Z,ab){return new W(X,Z,ab).resize(Y.length).set(0,Y);};W.ofSize=function(X,Y,Z,ab){return new W(X,Z,ab).resize(Y);};function X(Y,Z,ab){ab=ab||window.display;var bb=ab.gl;this.display=ab;this.gl=ab.gl;this.glia=ab.glia;this.vertSrc=Y;this.fragSrc=Z;this.texUnitCounter=0;this.indexBuf=null;this.vertShader=bb.createShader(bb.VERTEX_SHADER);this.fragShader=bb.createShader(bb.FRAGMENT_SHADER);bb.shaderSource(this.vertShader,this.vertSrc);bb.shaderSource(this.fragShader,this.fragSrc);bb.compileShader(this.vertShader);bb.compileShader(this.fragShader);if(!bb.getShaderParameter(this.vertShader,bb.COMPILE_STATUS)){throw("Error: Vertex shader compilation failed: "+bb.getShaderInfoLog(this.vertShader));}if(!bb.getShaderParameter(this.fragShader,bb.COMPILE_STATUS)){throw("Error: Fragment shader compilation failed: "+bb.getShaderInfoLog(this.fragShader));}this.prog=bb.createProgram();bb.attachShader(this.prog,this.vertShader);bb.attachShader(this.prog,this.fragShader);bb.linkProgram(this.prog);if(!bb.getProgramParameter(this.prog,bb.LINK_STATUS)){throw("A shader program linkage error occurred: "+this.gl.getProgramInfoLog(this.prog));}this.attributes={};this.uniforms={};bb.useProgram(this.prog);var cb=bb.getProgramParameter(this.prog,bb.ACTIVE_ATTRIBUTES);for(var db=0;db<cb;db++){var eb=bb.getActiveAttrib(this.prog,db);this.attributes[eb.name]={location:bb.getAttribLocation(this.prog,eb.name),type:eb.type,};}var eb=bb.getProgramParameter(this.prog,bb.ACTIVE_UNIFORMS);for(var db=0;db<eb;db++){var fb=bb.getActiveUniform(this.prog,db);this.uniforms[fb.name]={location:bb.getUniformLocation(this.prog,fb.name),type:fb.type,size:fb.size,};}};X.prototype={constructor:X,setAttribute:function(Y,Z,ab,bb,cb){ab=ab||0;bb=bb||0;cb=cb||0;var db=this.gl;var eb=this.glia;var fb=this.attributes[Y];if(fb===undefined)return this;var gb=fb.type;var hb=fb.location;var ib=(gb===db.FLOAT?1:gb===db.FLOAT_VEC2?2:gb===db.FLOAT_VEC3?3:gb===db.FLOAT_VEC4?4:0);if(ib===0){throw"Error: Attribute type not supported.";}Z.update();db.bindBuffer(Z.target,Z.buf);db.enableVertexAttribArray(hb);db.vertexAttribPointer(hb,ib,Z.gltype,false,ab,bb);eb.vertexAttribDivisorANGLE(hb,cb);return this;},setUniform:function(Y,Z){Z=Array.isArray(Z)?Z:[Z];var ab=this.gl;var bb=this.uniforms[Y];if(bb===undefined)return this;var cb=bb.type;var db=bb.location;var eb=(cb===ab.FLOAT?ab.uniform1fv:cb===ab.FLOAT_VEC2?ab.uniform2fv:cb===ab.FLOAT_VEC3?ab.uniform3fv:cb===ab.FLOAT_VEC4?ab.uniform4fv:cb===ab.INT||ab.BOOL?ab.uniform1iv:cb===ab.INT_VEC2||ab.BOOL_VEC2?ab.uniform2iv:cb===ab.INT_VEC3||ab.BOOL_VEC3?ab.uniform3iv:cb===ab.INT_VEC4||ab.BOOL_VEC4?ab.uniform4iv:cb===ab.FLOAT_MAT2?ab.uniformMatrix2fv:cb===ab.FLOAT_MAT3?ab.uniformMatrix3fv:cb===ab.FLOAT_MAt4?ab.uniformMatrix4fv:null);var fb=cb===ab.FLOAT_MAT2||cb===ab.FLOAT_MAT3||cb===ab.FLOAT_MAT4;if(eb===null){throw"Error: Uniform type not supported.";}ab.useProgram(this.prog);if(fb){eb.call(ab,db,false,Z);}else{eb.call(ab,db,Z);}return this;},setTexture:function(Y,Z){var ab=this.gl;var bb=this.uniforms[Y];if(bb===undefined)return this;var cb=bb.type;var db=bb.location;if(cb!==ab.SAMPLER_2D){throw"Error: Uniform type must be sampler2D.";}this.gl.activeTexture(this.gl.TEXTURE0+this.texUnitCounter);this.gl.bindTexture(this.gl.TEXTURE_2D,Z.tex);this.gl.uniform1i(db,this.texUnitCounter);this.texUnitCounter++;return this;},setTextureArray:function(Y,Z){if(Z.length===0){return this;}Y=Y+"[0]";var ab=this.gl;var bb=this.uniforms[Y];if(bb===undefined)return this;var cb=bb.type;var db=bb.location;if(cb!==ab.SAMPLER_2D){throw"Error: Uniform type must be sampler2D.";}var eb=Array(Z.length);for(var fb=0;fb<Z.length;fb++){eb[fb]=this.texUnitCounter+fb;this.gl.activeTexture(this.gl.TEXTURE0+eb[fb]);this.gl.bindTexture(this.gl.TEXTURE_2D,Z[fb].tex);}this.gl.uniform1iv(db,eb);this.texUnitCounter+=Z.length;return this;},resetTextures:function(){this.texUnitCounter=0;return this;},setIndices:function(Y){var Z=this.gl;this.indexBuf=Y;Y.update();Z.bindBuffer(Z.ELEMENT_ARRAY_BUFFER,Y.buf);},drawTriangleStrip:function(Y,Z){var ab=this.gl;var bb=this.glia;Z=Z||1;if(this.indexBuf!==null){bb.drawElementsInstancedANGLE(ab.TRIANGLE_STRIP,this.indexBuf.len,this.indexBuf.gltype,0,Z);}else{bb.drawArraysInstancedANGLE(ab.TRIANGLE_STRIP,0,Y,Z);}},};S.shaders=S.shaders||{};T.shader=function(Y,Z,ab,bb,cb){Z=Array.isArray(Z)?Z:[Z];ab=Array.isArray(ab)?ab:[ab];var db=Z.length;var eb=ab.length;var fb=null;var gb=null;function hb(){db--;if(db===0){fb="precision highp float;precision highp int;";fb+=this.combineTextFromUrls(Z);if(fb!==null&&gb!==null){S.shaders[Y]=new X(fb,gb,cb);bb();}}}function ib(){eb--;if(eb===0){gb="#extension GL_EXT_frag_depth : enable\n";gb+="precision highp float;precision highp int;";gb+=this.combineTextFromUrls(ab);if(fb!==null&&gb!==null){S.shaders[Y]=new X(fb,gb,cb);bb();}}}bb=bb||a;cb=cb||V;if(S.shaders[Y]){bb();return this;}for(var jb=0;jb<Z.length;jb++){var kb=Z[jb];this.text(kb,hb.bind(this));}for(var jb=0;jb<ab.length;jb++){var kb=ab[jb];this.text(kb,ib.bind(this));}return this;};T.combineTextFromUrls=function(Y){var Z="";for(var ab=0;ab<Y.length;ab++){var bb=Y[ab];var cb=this.getItem(bb);Z+=cb;}return Z;};var Y=0;function Z(ab){ab=ab||V;var bb=ab.gl;this.gid=Y++;this.display=ab;this.gl=ab.gl;this.tex=this.gl.createTexture();this.img=null;this.size=[0,0];bb.bindTexture(bb.TEXTURE_2D,this.tex);bb.texParameteri(bb.TEXTURE_2D,bb.TEXTURE_MIN_FILTER,bb.NEAREST);bb.texParameteri(bb.TEXTURE_2D,bb.TEXTURE_MAG_FILTER,bb.NEAREST);};Z.prototype={constructor:Z,fromImage:function(ab){var bb=this.gl;bb.bindTexture(bb.TEXTURE_2D,this.tex);bb.texImage2D(bb.TEXTURE_2D,0,bb.RGBA,bb.RGBA,bb.UNSIGNED_BYTE,ab);this.img=ab;this.size=[ab.width,ab.height];return this;},};T.texture=function(ab,bb,cb){function db(){var eb=this.getItem(ab);var fb=new Z(cb).fromImage(eb);this.setItem(ab,fb);bb();}bb=bb||a;cb=cb||V;if(this.getItem(ab)!==undefined){bb();}this.image(ab,db.bind(this));return this;};var ab=u(3)/2;var bb=k(1/u(3));var cb=u(2/3);var db=1/u(3);var eb=1/3;var fb=[0,0,-1];fb=L(fb,w(-45));fb=N(fb,w(30));var gb=32;var hb=gb;var ib=gb*2;var jb=hb*ib;var kb=hb+1;var lb=ib+1;var mb=lb*kb;var nb=gb*2;var ob=gb*2;var pb=ob*nb;var qb=(nb+2+2)*ob-2;var rb=11;function sb(tb){return[tb[0]-1,tb[1]];}function tb(ub){return[ub[0]+1,ub[1]];}function ub(vb){return[vb[0]-1+v(vb[1],2),vb[1]-1,];}function vb(wb){return[wb[0]+v(wb[1],2),wb[1]-1,];}function wb(xb){return[xb[0]-1+v(xb[1],2),xb[1]+1,];}function xb(yb){return[yb[0]+v(yb[1],2),yb[1]+1,];}function yb(zb){return zb[0]+zb[1]*kb;}function zb(Ab){return[m(Ab[0]/hb),m(Ab[1]/ib),];}function Ab(Bb){return[v(Bb[0],hb),v(Bb[1],ib),];}function Bb(Cb,Db){return[Cb[0]*hb+Db[0],Cb[1]*ib+Db[1],];}function Cb(Db){return[Db[0]+0.5*v(Db[1],2),Db[1]*ab,Db[2]*eb,];}function Db(Eb){return[V.width/2+camera.zoom*(-camera.pos[0]+Eb[0]),V.height/2+camera.zoom*(-camera.pos[1]+Eb[1]*db-Eb[2]*cb),];}function Eb(Fb){return Db(Cb(Fb));}mapgen={perlin:new R(),height:function(Fb){return this.perlin.sample(Fb)*4;},terra:function(Fb){return m(this.perlin.sample(Fb)*2)+1;},};function Fb(Gb,Hb){this.frame=Gb;this.pos=Hb||[0,0];this.chunk=null;}Fb.prototype={constructor:Fb,attachChunk:function(Gb){this.chunk=Gb||null;return this;},setPos:function(Gb){this.pos=Gb;if(this.chunk!==null){this.chunk.updateData(this);}return this;},setFrame:function(Gb){this.frame=Gb;if(this.chunk!==null){this.chunk.updateData(this);}return this;},};function Gb(Hb){this.chunk=Hb;this.map=Hb.map;this.shader=S.shaders.obj;this.texTable={};this.textures=[];this.texCount=0;this.objs=Array(mb);this.data=W.ofSize("float",mb*rb);for(var Ib=0;Ib<hb;Ib++){for(var Jb=0;Jb<ib;Jb++){if(r()<0.125){this.add(new Fb(S.frames.tree_png,[Ib,Jb]));}}}}Gb.prototype={constructor:Gb,add:function(Hb){var Ib=yb(Hb.pos);this.objs[Ib]=Hb;this.objs[Ib].attachChunk(this);this.updateData(Hb);},remove:function(Hb){var Ib=yb(Hb.pos);this.objs[Ib].attachChunk();this.objs[Ib]=undefined;this.updateData(Hb);},updateData:function(Hb){var Ib=yb(Hb.pos);if(this.texTable[Hb.frame.texgid]===undefined){this.texTable[Hb.frame.texgid]={id:this.texCount,tex:Hb.frame.texture,};this.textures.push(Hb.frame.texture);this.texCount++;}var Jb=this.texTable[Hb.frame.texgid].id;log(this.texTable);this.data.set(Ib*rb,[Hb.pos[0],Hb.pos[1],Hb.frame.size[0],Hb.frame.size[1],Hb.frame.anchor[0],Hb.frame.anchor[1],Hb.frame.texcoordpos[0],Hb.frame.texcoordpos[1],Hb.frame.texcoordsize[0],Hb.frame.texcoordsize[1],Jb,]);},draw:function(){var Hb=this.shader;var Ib=rb*4;var Jb=this.data;Hb.setAttribute("aVert",this.map.objVerts);Hb.setAttribute("aPos",Jb,Ib,0*4,1);Hb.setAttribute("aSize",Jb,Ib,2*4,1);Hb.setAttribute("aAnchor",Jb,Ib,4*4,1);Hb.setAttribute("aTexCoordPos",Jb,Ib,6*4,1);Hb.setAttribute("aTexCoordSize",Jb,Ib,8*4,1);Hb.setAttribute("aTexId",Jb,Ib,10*4,1);Hb.setAttribute("aHeight",this.chunk.heights,0,0,1);Hb.setUniform("uChunkSize",gb);Hb.setUniform("uChunkCoord",this.chunk.pos);Hb.setUniform("uScreenSize",[V.width,V.height]);Hb.setUniform("uCameraPos",camera.pos);Hb.setUniform("uDefZoom",camera.defzoom);Hb.setUniform("uZoom",camera.zoom);Hb.resetTextures();Hb.setTextureArray("uTextures",this.textures);Hb.drawTriangleStrip(4,mb);},};function Hb(Ib,Jb){this.map=Ib;this.pos=Jb;this.heights=new W("ubyte").resize(mb);this.terra=new W("ubyte").resize(mb);this.normals=new W("float").resize(mb*3);for(var Kb=0;Kb<lb;Kb++){for(var Lb=0;Lb<kb;Lb++){var Mb=yb([Lb,Kb]);var Nb=Bb(this.pos,[Lb,Kb]);this.heights.set(Mb,Ib.gen.height(Nb));this.terra.set(Mb,Ib.gen.terra(Nb));}}this.objchunk=new Gb(this);}(function(){this.drawTerra=function(){var Ib=this.map.shader;Ib.setAttribute("aHeight",this.heights);Ib.setAttribute("aNormal",this.normals);Ib.setAttribute("aTerra",this.terra);Ib.setUniform("uChunkCoord",this.pos);Ib.drawTriangleStrip();};this.drawObjs=function(){this.objchunk.draw();};this.updateNormals=function(){for(var Ib=0;Ib<lb;Ib++){for(var Jb=0;Jb<kb;Jb++){var Kb=yb([Jb,Ib]);var Lb=Bb(this.pos,[Jb,Ib]);var Mb=[map.getVertex(sb(Lb)),map.getVertex(ub(Lb)),map.getVertex(vb(Lb)),map.getVertex(tb(Lb)),map.getVertex(xb(Lb)),map.getVertex(wb(Lb)),];var Nb=[I(Mb[0],Mb[1]),I(Mb[1],Mb[2]),I(Mb[2],Mb[3]),I(Mb[3],Mb[4]),I(Mb[4],Mb[5]),I(Mb[5],Mb[0]),];var Ob=[0,0,0];Nb.forEach(function(Pb){Ob=H(Ob,Pb);});Ob=K(Ob);this.normals.set(Kb*3,Ob);}}};}).call(Hb.prototype);function Ib(){this.gen=mapgen;this.chunks=new P();this.shader=S.shaders.map;this.mapCoords=new W("short").resize(mb*2);this.indices=new W("ushort",true).resize(qb);this.objVerts=W.fromArray("byte",[0,1,2,3]);for(var Jb=0;Jb<lb;Jb++){for(var Kb=0;Kb<kb;Kb++){this.mapCoords.set(yb([Kb,Jb])*2,[Kb,Jb]);}}for(var Jb=0,i=0;Jb<ob;Jb++){var Kb=Jb%2===0;var Lb=!Kb;for(var Mb=0;Mb<nb;Mb++){var Nb=Kb&&Mb%2==0||Lb&&Mb%2==1;var Ob=!Nb;this.indices.set(i++,(Jb+Ob)*kb+m(Mb/2));if(Mb==0&&Jb>0){this.indices.set(i++,this.indices.data[i-2]);}}this.indices.set(i++,(Jb+1+Lb)*kb-1);this.indices.set(i++,(Jb+1+Kb)*kb-1);if(Jb<ob-1){this.indices.set(i++,this.indices.data[i-2]);}}}Ib.prototype={constructor:Ib,getHeight:function(Jb){var Kb=zb(Jb);var Lb=Ab(Jb);var Mb=this.getChunk(Kb);var Nb=yb(Lb);return Mb===undefined?0:Mb.heights.data[Nb];},setHeight:function(Jb,Kb){var Lb=zb(Jb);var Mb=Ab(Jb);var Nb=this.getChunk(Lb);var Ob=yb(Mb);if(Nb!==undefined){Nb.heights.set(Ob,Kb);}},getVertex:function(Jb){return Cb(F(Jb,this.getHeight(Jb)));},draw:function(){this.shader.setAttribute("aMapCoord",this.mapCoords);this.shader.setIndices(this.indices);this.shader.setUniform("uChunkSize",gb);this.shader.setUniform("uScreenSize",[V.width,V.height]);this.shader.setUniform("uZoom",camera.zoom);this.shader.setUniform("uCameraPos",camera.pos);this.shader.setUniform("uSun",fb);this.shader.resetTextures();this.shader.setTexture("uTex",S.gfx.terrain_png);this.chunks.each(function(Jb,Kb,Lb){Jb.drawTerra();});var Jb=V.gl;Jb.enable(Jb.DEPTH_TEST);Jb.depthFunc(Jb.GEQUAL);Jb.clearDepth(-1);Jb.clear(Jb.DEPTH_BUFFER_BIT);this.chunks.each(function(Kb,Lb,Mb){Kb.drawObjs();});Jb.disable(Jb.DEPTH_TEST);},getChunk:function(Jb){return this.chunks.get(Jb);},setChunk:function(Jb,Kb){this.chunks.set(Jb,Kb);},addChunk:function(Jb){if(this.getChunk(Jb)===undefined){var Kb=new Hb(this,Jb);this.setChunk(Jb,Kb);Kb.updateNormals();var Lb=this.getChunk([Jb[0]-1,Jb[1]]);if(Lb)Lb.updateNormals();}},addObj:function(Jb){var Kb=zb(Jb.pos);this.chunks.get(Kb).objchunk.add(Jb);},};function Jb(Kb,Lb){this.texture=Kb;this.texgid=Kb.gid;this.name=Lb.name;this.pos=Lb.pos;this.size=Lb.size;this.osize=Lb.osize;this.pad=Lb.pad;this.pivot=[128-this.pad[0],112-this.pad[1]];this.texcoordpos=E(this.pos,Kb.size);this.texcoordsize=E(this.size,Kb.size);this.anchor=E(this.pivot,this.size);}S.frames=S.frames||{};T.atlas=function(Kb,Lb,Mb){var Nb;var Ob;var Pb;Lb=Lb||a;Mb=Mb||V;if(this.getItem(Kb)!==undefined){Lb();}this.json(Kb,Nb.bind(this));return this;function Nb(){Pb=this.getItem(Kb);this.texture(Pb.source,Ob.bind(this))}function Ob(){var Qb=this.getItem(Pb.source);for(var Rb=0;Rb<Pb.frames.length;Rb++){var Sb=Pb.frames[Rb];var Tb=new Jb(Qb,Sb);S.frames[this.filenameToIdent(Sb.name)]=Tb;}Lb();}};function Kb(Lb,Mb,Nb,Ob){Ob=Ob||V;this.display=Ob;this.div=g("div");this.div.style.position="absolute";this.display.container.appendChild(this.div);this.setPos(0,0);this.setText(Lb||"New Label");}Kb.prototype={constructor:Kb,setText:function(Lb){this.text=Lb;this.div.innerHTML=Lb;return this;},setFont:function(Lb){this.div.style.fontFamily=Lb;return this;},setColor:function(Lb){this.div.style.color=Lb;return this;},setPos:function(Lb,Mb){this.pos=[Lb,Mb];this.div.style.left=Lb+"px";this.div.style.top=Mb+"px";return this;},};function Lb(){this.defzoom=32;this.zoom=this.defzoom;this.pos=[0,0];}Lb.prototype={constructor:Lb,move:function(Mb,Nb){this.pos[0]+=Mb/this.zoom;this.pos[1]+=Nb/this.zoom;},};function Mb(Nb){Nb=Nb||V;this.display=Nb;this.elm=Nb.container;this.moving=false;this.elm.addEventListener("mousemove",this.onMouseMove.bind(this));this.elm.addEventListener("mousedown",this.onMouseDown.bind(this));this.elm.addEventListener("mouseup",this.onMouseUp.bind(this));this.elm.addEventListener("wheel",this.onMouseWheel.bind(this));}Mb.prototype={constructor:Mb,updateMouse:function(Nb){var Ob=this.elm.getBoundingClientRect();this.mouseX=Nb.clientX-Ob.left;this.mouseY=Nb.clientY-Ob.top;this.mouseRelX=Nb.movementX;this.mouseRelY=Nb.movementY;},onMouseMove:function(Nb){this.updateMouse(Nb);if(this.moving){camera.move(this.mouseRelX,this.mouseRelY);}var Ob=((this.mouseY-V.height/2)/camera.zoom+camera.pos[1])*2;var Pb=m(Ob);var Qb=(this.mouseX-V.width/2)/camera.zoom+camera.pos[0]-j(Pb%2)*0.5;var Rb=s(Qb);var Sb=Qb<Rb;var Tb=j(Pb%2)===1;var Ub=1000000;var Vb=1000000;var Wb=1000000;for(var Xb=0;Xb<6;Xb++){var Yb=j((Pb+Xb)%2)===1;var Zb=Tb?!Yb*!Sb*+1:Yb*Sb*-1;var ac=Rb+Zb;var bc=Pb+Xb;var cc=Eb([ac,bc,map.getHeight([ac,bc])]);var dc=q(this.mouseX-cc[0],2)+q(this.mouseY-cc[1],2);labels[Xb].setPos(cc[0],cc[1]);if(dc<Ub){Ub=dc;Vb=ac;Wb=bc;}}var Yb=Eb([Vb,Wb,map.getHeight([Vb,Wb])]);labels[0].setPos(Yb[0],Yb[1]);labels[1].setPos(0,0);labels[2].setPos(0,0);labels[3].setPos(0,0);labels[4].setPos(0,0);labels[5].setPos(0,0);},onMouseDown:function(Nb){this.updateMouse(Nb);this.moving=true;V.canvas.requestPointerLock();},onMouseUp:function(Nb){this.updateMouse(Nb);this.moving=false;document.exitPointerLock();},onMouseWheel:function(Nb){this.updateMouse(Nb);if(Nb.deltaY>0){this.onMouseWheelDown();}else{this.onMouseWheelUp();}},onMouseWheelDown:function(){camera.zoom/=1.25;},onMouseWheelUp:function(){camera.zoom*=1.25;},};var Nb;var Ob;T.texture("gfx/terrain.png").shader("map",["shaders/utils.glslv","shaders/map.vert.glslv"],["shaders/map.frag.glslf"],).shader("mapcoord",["shaders/utils.glslv","shaders/mapcoord.vert.glslv"],["shaders/utils.glslv","shaders/mapcoord.frag.glslf"],).shader("obj",["shaders/utils.glslv","shaders/obj.glslv"],"shaders/obj.glslf",).atlas("gfx/test.json").atlas("gfx/test2.json").atlas("gfx/test3.json").ready(Nb);function Nb(){V.attachToBody().enableFullPageMode().setBgColor(1,1,1,1);camera=new Lb();map=new Ib();input=new Mb();var Pb=1;for(var Qb=-Pb;Qb<=Pb;Qb++){for(var Rb=-Pb;Rb<=Pb;Rb++){map.addChunk([Qb,Rb]);}}labels=[new Kb("A").setColor("#f00").setPos(16,16),new Kb("B").setColor("#0f0").setPos(16,16),new Kb("C").setColor("#00f").setPos(16,16),new Kb("D").setColor("#0ff").setPos(16,16),new Kb("E").setColor("#f0f").setPos(16,16),new Kb("F").setColor("#ff0").setPos(16,16),];V.onRender=Ob;}function Ob(){map.draw();}})();
